<!DOCTYPE html>
<html lang = "en">
    <head>
    <title>
        Calendar
    </title>
    <link rel="stylesheet" type="text/css" href="calendar.css" />
    </head>
    <body>

            <input type="text" id="username" placeholder="Username" />
            <input type="password" id="password" placeholder="Password" />
            <button id="login_btn">Log In</button>

            <br>

                    <label for="newuser"> Enter New Username:</label>
                    <input type="text" name="username" id="newuser" />

                    <label for="newuserpassword"> Create Password:</label>
                    <input type="text" name="password" id="newuserpassword" />
                
                    <input type="hidden" name="token" value="<?php echo $_SESSION['token'];?>" />
                    <button id="createacct_btn">Register</button>




             <!--<div class="calender" id="calender">
                             <div class="month"> </div>
                                <div class="dayofweek"> <div>sun </div> <div>mon </div> <div>tues </div> <div>wed </div> <div>thurs </div> <div>fri </div> <div>sat </div> </div>
                                <div class="daygrid"> <div>1</div> <div>1</div> <div>1</div> 
                                <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div> 
                                <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div> 
                                <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div> 
                                <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div><div>1</div> <div>1</div> 
                                <div>1</div> <div>1</div> <div>1</div> <div>1</div> <div>1</div></div>
                                <div class ="event"> <div>Class</div></div>
                                
                            </div>-->
                        <table class = 'table' style="width:100%">
                            <tr id=month class='month'>  </tr>
                            <tr class='dayofweek'>
                                <th>Sunday</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                            </tr>
                            <tr class='daygrid'>
                                <td id=1> </td>
                                <td id=2> </td>
                                <td id=3> </td>
                                <td id=4> </td>
                                <td id=5> </td>
                                <td id=6> </td>
                                <td id=7> </td>
                            </tr>
                            <tr class='daygrid'>
                                    <td id=8>  </td>
                                    <td id=9> </td>
                                    <td id=10> </td>
                                    <td id=11> </td>
                                    <td id=12> </td>
                                    <td id=13> </td>
                                    <td id=14> </td>
                            </tr>
                                <tr class='daygrid'>
                                        <td id=15> </td>
                                        <td id=16> </td>
                                        <td id=17> </td>
                                        <td id=18> </td>
                                        <td id=19> </td>
                                        <td id=20> </td>
                                        <td id=21> </td>
                                    </tr>
                                    <tr class='daygrid'>
                                            <td id=22> </td>
                                            <td id=23> </td>
                                            <td id=24> </td>
                                            <td id=25> </td>
                                            <td id=26> </td>
                                            <td id=27> </td>
                                            <td id=28> </td>
                                        </tr>
                                        <tr class='daygrid'>
                                                <td id=29> </td>
                                                <td id=30> </td>
                                                <td id=31> </td>
                                                <td id=32> </td>
                                                <td id=33> </td>
                                                <td id=34> </td>
                                                <td id=35> </td>
                                            </tr>
                                            <tr class='daygrid'>
                                                    <td id=36> </td>
                                                    <td id=37> </td>
                                                    <td id=38> </td>
                                                    <td id=39> </td>
                                                    <td id=40> </td>
                                                    <td id=41> </td>
                                                    <td id=42> </td>
                                                </tr>
                        </table>
                        
            <input type="submit" value="Previous Month" id="previous_month_btn"/>            
            <input type="submit" value="Next Month" id="next_month_btn"/>



            <label for="title"> Title of Event:</label>
            <input type="text" name="title" id="title" />

            <label for="date"> Date of Event:</label>
            <input type="text" name="date" id="date" />

            <label for="time"> Time of Event:</label>
            <input type="text" name="time" id="time" />

            <button id="event_btn">Add Event</button>
            <button id="delete_btn">Remove Event</button>

            

            <input type='hidden' onclick= 'session_destroy() ' name='token' value='$_SESSION[token]'/>
            <input type='submit' value='Logout' id='logout_btn'/>

    <script>
        (function(){Date.prototype.deltaDays=function(c){return new Date(this.getFullYear(),this.getMonth(),this.getDate()+c)};Date.prototype.getSunday=function(){return this.deltaDays(-1*this.getDay())}})();
function Week(c){this.sunday=c.getSunday();this.nextWeek=function(){return new Week(this.sunday.deltaDays(7))};this.prevWeek=function(){return new Week(this.sunday.deltaDays(-7))};this.contains=function(b){return this.sunday.valueOf()===b.getSunday().valueOf()};this.getDates=function(){for(var b=[],a=0;7>a;a++)b.push(this.sunday.deltaDays(a));return b}}
function Month(c,b){this.year=c;this.month=b;this.nextMonth=function(){return new Month(c+Math.floor((b+1)/12),(b+1)%12)};this.prevMonth=function(){return new Month(c+Math.floor((b-1)/12),(b+11)%12)};this.getDateObject=function(a){return new Date(this.year,this.month,a)};this.getWeeks=function(){var a=this.getDateObject(1),b=this.nextMonth().getDateObject(0),c=[],a=new Week(a);for(c.push(a);!a.contains(b);)a=a.nextWeek(),c.push(a);return c}};
        
var currentMonth = new Month(2019, 9);
const month = document.getElementById("month");
//month.appendChild(document.createTextNode(currentMonth.month));
function getDays(month){

    if(month==0 || month==2 || month==4 || month==6 || month==7 || month==9 || month==11){
        return 31;
    }
    else if(month!=1){
        return 30;
    }
    else{
        if(currentMonth.year%4!=0){
            return 28;
        }
        else{
            return 29;
        }
    }
}

updateCalendar();

function updateCalendar(){
    let days = 0;
    let startingday = 0;

    if(month.firstChild!=null){
    month.removeChild(month.lastChild);
    }
    month.appendChild(document.createTextNode(currentMonth.month));

            dayzero = getDayZero();
            let diff = getDays(currentMonth.prevMonth().month) - dayzero;
            days = getDays(currentMonth.month);
            if(dayzero!=1){
                startingday = diff+2;
                }
            else{
                startingday = 1;
        }
    
 

    let titles_array = new Array();
    let years_array = new Array();
    let months_array = new Array();
    let days_array = new Array();
    let times_array = new Array();
    let num = 0;

    fetch("events.php", {
            method: 'POST',
        })
        .then(function(response){

            return response.json()
        })
        //.then(response => response.json())
        .then(function(data){
            for(i=0;i<data.num;i++){

            if(currentMonth.year==data.year[i]){
                if(currentMonth.month==data.month[i]){
                    dayzero = getDayZero();
                    diff = getDays(currentMonth.prevMonth().month) - dayzero;
                    days = getDays(currentMonth.month);
                    if(dayzero!=1){
                        start = diff+2;
                    }
                    else{
                        start = 1;
                    }
                    document.getElementById(start+data.day[i]-1).appendChild(document.createTextNode(data.title[i]));
                    let delete_btn = document.createElement("button");
                    delete_btn.appendChild(document.createTextNode("Delete"));
                    document.getElementById(start+data.day[i]-1).appendChild(delete_btn);
                }
            }


                // titles_array.push(data.title[i]);
                // years_array.push(data.year[i]);
                // months_array.push(data.month[i]);
                // days_array.push(data.day[i]);
                // times_array.push(data.time[i]);
            }
            num = data.num;

        })

    for(j=1;j<43;j++){
    while(document.getElementById(j).firstChild!=null){
        document.getElementById(j).removeChild(document.getElementById(j).lastChild);
}
}
for(b=1;b<days+1;b++){

document.getElementById(startingday).appendChild(document.createTextNode(b));

// for(k=0;k<4;k++){
//     if(currentMonth.month==months_array[k]){
//         console.log("3");
//         document.getElementById(startingday).appendChild(document.createTextNode(titles_array[k]));
//     }
// }

startingday++;}
}

function getDayZero(){
    var weeks = currentMonth.getWeeks();
    let a = 0;
    let dayzero = 0;
	for(var w in weeks){
        var days = weeks[w].getDates();
        if(a==0){
            dayzero = days[0].getDate();}
        a++;}
        a=0;
        return dayzero;
}

function nextMonth(event){
    currentMonth=currentMonth.nextMonth();
    updateCalendar();
    // if(month.firstChild!=null){
    // month.removeChild(month.lastChild);
    // }
    // month.appendChild(document.createTextNode(currentMonth.month));

    //         dayzero = getDayZero();
    //         let diff = getDays(currentMonth.prevMonth().month) - dayzero;
    //         if(dayzero!=1){
    //             let firstday = diff+2;
    //             updateCalendar(getDays(currentMonth.month),firstday);}
    //         else{
    //             updateCalendar(getDays(currentMonth.month),1);
    //     }
}

function previousMonth(){
    currentMonth = currentMonth.prevMonth();
    updateCalendar();

//     if(month.firstChild!=null){
//     month.removeChild(month.lastChild);
//     }
//     month.appendChild(document.createTextNode(currentMonth.month));

//             dayzero = getDayZero();
//             let diff = getDays(currentMonth.prevMonth().month) - dayzero;
//             if(dayzero!=1){
//                 let firstday = diff+2;
//                 updateCalendar(getDays(currentMonth.month),firstday);}
//             else{
//                 updateCalendar(getDays(currentMonth.month),1);
//         }
 }


document.getElementById("previous_month_btn").addEventListener("click", previousMonth, false);

document.getElementById("next_month_btn").addEventListener("click", function(event){
    //currentMonth = currentMonth.nextMonth();
	nextMonth();
}, false);

        
document.getElementById("login_btn").addEventListener("click", login, false);
document.getElementById("createacct_btn").addEventListener("click", createacct, false);
document.getElementById("event_btn").addEventListener("click", addevent, false);
document.getElementById("logout_btn").addEventListener("click", updateCalendar, false);
document.getElementById("delete_btn").addEventListener("click", removeevent, false);


function login(event) {
    event.preventDefault();
    let username = document.getElementById("username").value; // Get the username from the form
    let password = document.getElementById("password").value; // Get the password from the form


    
    // Make a URL-encoded string for passing POST data:
    let data = { 'username': username, 'password': password };
    let path = 'login_ajax.php';
    fetch(`./login_ajax.php`, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 
                'content-type': 'application/json',
                'Accept': 'application/json'
         }
        })
        .then(response => response.json())
        .then(data => alert(data.success ? "Hello " + username + "/ronald you've been logged in!" : `You were not logged in ${data.message}`));



    //     if(username=='ronald'){
    // src = 'https://cpb-us-w2.wpmucdn.com/sites.wustl.edu/dist/2/1297/files/2015/07/ron-cytron.jpg';
    //         img = document.createElement('img');
    //         img.src = src;
    //         month.appendChild(img);}

        //.then(data => console.log(data.success));

    }

function createacct(event) {
    event.preventDefault();
    let username = document.getElementById("newuser").value; // Get the username from the form
    let password = document.getElementById("newuserpassword").value; // Get the password from the form

    // Make a URL-encoded string for passing POST data:
    let data = { 'username': username, 'password': password };
    let path = 'createacct_ajax.php';
    fetch(`./createacct_ajax.php`, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 
                'content-type': 'application/json',
                'Accept': 'application/json'
         }
        })
        //.then(response => response.json())
        //.then(data => console.log(data.success ? "You've been logged in!" : `You were not logged in ${data.message}`));
        //.then(data => console.log(data.success));

    }


    function addevent(event) {
    event.preventDefault();
    let title = document.getElementById("title").value; 
    let date = document.getElementById("date").value; 
    let time = document.getElementById("time").value; 


    let data = { 'title': title, 'date': date, 'time': time};
    let path = 'addevent_ajax.php';
    fetch(`./addevent_ajax.php`, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 
                'content-type': 'application/json',
                'Accept': 'application/json'
         }
        })
        .then(response => response.json())
        .then(data => updateCalendar()
);
    }

    function removeevent(event) {
    event.preventDefault();
    

    }

    </script>









    </body>
    </html>